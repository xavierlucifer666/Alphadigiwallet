<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpha Digiwallet - Backend MVP Code Structure</title>
    <style>
        :root {
            --color-bg-primary: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-surface: #334155;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-accent: #38bdf8;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 100%);
            color: var(--color-text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: var(--color-bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--color-accent);
        }

        h1 {
            color: var(--color-accent);
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--color-text-secondary);
            font-size: 1.1rem;
        }

        .section {
            background: var(--color-bg-secondary);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--color-accent);
        }

        .section h2 {
            color: var(--color-accent);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .section h3 {
            color: var(--color-success);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .code-block {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-bg-surface);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            overflow-x: auto;
            position: relative;
        }

        .file-header {
            color: var(--color-warning);
            font-weight: bold;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-header::before {
            content: "üìÑ";
        }

        pre {
            margin: 0;
            color: var(--color-text-secondary);
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .folder-structure {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-bg-surface);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .folder-structure .folder {
            color: var(--color-warning);
        }

        .folder-structure .file {
            color: var(--color-success);
        }

        .info-box {
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid var(--color-accent);
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .info-box h4 {
            color: var(--color-accent);
            margin-bottom: 0.75rem;
        }

        .info-box ul {
            margin-left: 1.5rem;
            color: var(--color-text-secondary);
        }

        .info-box li {
            margin-bottom: 0.5rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: var(--color-bg-surface);
            color: var(--color-text-primary);
            border: 2px solid transparent;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn:hover {
            border-color: var(--color-accent);
            background: var(--color-bg-primary);
        }

        .tab-btn.active {
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border-color: var(--color-accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .copy-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--color-accent);
            color: var(--color-bg-primary);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: var(--color-success);
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: var(--color-success);
        }

        .endpoint-card {
            background: var(--color-bg-primary);
            border: 1px solid var(--color-bg-surface);
            border-radius: 8px;
            padding: 1rem;
            margin: 0.75rem 0;
        }

        .endpoint-header {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .method {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .method.post {
            background: var(--color-success);
            color: white;
        }

        .method.get {
            background: var(--color-accent);
            color: white;
        }

        .method.put {
            background: var(--color-warning);
            color: white;
        }

        .endpoint-path {
            color: var(--color-text-secondary);
            font-family: 'Courier New', monospace;
        }

        .endpoint-desc {
            color: var(--color-text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Alpha Digiwallet Backend MVP</h1>
            <p class="subtitle">Production-Ready Node.js + Express + SQL Server</p>
            <p class="subtitle" style="margin-top: 0.5rem; font-size: 0.95rem;">Complete code package ready for deployment</p>
        </header>

        <!-- Project Structure Section -->
        <div class="section">
            <h2>üìÅ Project Structure</h2>
            <div class="folder-structure">
<pre><span class="folder">alpha-digiwallet-backend/</span>
‚îú‚îÄ‚îÄ <span class="folder">src/</span>
‚îÇ   ‚îú‚îÄ‚îÄ <span class="folder">config/</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">database.js</span>          # SQL Server connection
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">config.js</span>            # Environment config
‚îÇ   ‚îú‚îÄ‚îÄ <span class="folder">middleware/</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">auth.js</span>              # JWT authentication
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">validation.js</span>        # Request validation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">errorHandler.js</span>      # Error handling
‚îÇ   ‚îú‚îÄ‚îÄ <span class="folder">models/</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">User.js</span>              # User model
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">Wallet.js</span>            # Wallet model
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">Transaction.js</span>       # Transaction model
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">Merchant.js</span>          # Merchant model
‚îÇ   ‚îú‚îÄ‚îÄ <span class="folder">routes/</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">auth.js</span>              # Auth endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">wallet.js</span>            # Wallet endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">transaction.js</span>       # Transaction endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">merchant.js</span>          # Merchant endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">admin.js</span>             # Admin endpoints
‚îÇ   ‚îú‚îÄ‚îÄ <span class="folder">controllers/</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">authController.js</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">walletController.js</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">transactionController.js</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">merchantController.js</span>
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">adminController.js</span>
‚îÇ   ‚îú‚îÄ‚îÄ <span class="folder">services/</span>
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">walletService.js</span>     # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ <span class="file">transactionService.js</span>
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">pspSimulator.js</span>      # PSP mock
‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">app.js</span>                   # Express app setup
‚îú‚îÄ‚îÄ <span class="folder">database/</span>
‚îÇ   ‚îî‚îÄ‚îÄ <span class="file">schema.sql</span>               # SQL Server schema
‚îú‚îÄ‚îÄ <span class="file">.env.example</span>                 # Environment template
‚îú‚îÄ‚îÄ <span class="file">package.json</span>
‚îú‚îÄ‚îÄ <span class="file">server.js</span>                    # Entry point
‚îî‚îÄ‚îÄ <span class="file">README.md</span></pre>
            </div>
        </div>

        <!-- Quick Start Section -->
        <div class="section">
            <h2>‚ö° Quick Start</h2>
            <div class="info-box">
                <h4>Installation Steps</h4>
                <ol>
                    <li>Download all code files below</li>
                    <li>Run: <code>npm install</code></li>
                    <li>Create SQL Server database: <code>AlphaDigiwallet</code></li>
                    <li>Run schema: <code>database/schema.sql</code></li>
                    <li>Copy <code>.env.example</code> to <code>.env</code> and configure</li>
                    <li>Start server: <code>npm start</code></li>
                    <li>API running at: <code>http://localhost:3000</code></li>
                </ol>
            </div>
        </div>

        <!-- Code Files Section with Tabs -->
        <div class="section">
            <h2>üíª Complete Source Code</h2>
            
            <div class="tabs">
                <button class="tab-btn active" data-tab="setup">Setup Files</button>
                <button class="tab-btn" data-tab="config">Configuration</button>
                <button class="tab-btn" data-tab="models">Models</button>
                <button class="tab-btn" data-tab="middleware">Middleware</button>
                <button class="tab-btn" data-tab="controllers">Controllers</button>
                <button class="tab-btn" data-tab="routes">Routes</button>
                <button class="tab-btn" data-tab="services">Services</button>
                <button class="tab-btn" data-tab="database">Database</button>
            </div>

            <!-- Setup Files Tab -->
            <div class="tab-content active" data-tab-content="setup">
                <div class="code-block">
                    <div class="file-header">package.json</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>{
  "name": "alpha-digiwallet-backend",
  "version": "1.0.0",
  "description": "Alpha Digiwallet Payment Aggregator Backend",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "mssql": "^10.0.1",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "joi": "^17.11.0",
    "helmet": "^7.1.0",
    "express-session": "^1.17.3",
    "winston": "^3.11.0",
    "body-parser": "^1.20.2",
    "dotenv": "^16.3.1",
    "express-rate-limit": "^7.1.5",
    "cors": "^2.8.5",
    "uuid": "^9.0.1"
  },
  "devDependencies": {
    "nodemon": "^3.0.2"
  }
}</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">.env.example</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre># Server Configuration
PORT=3000
NODE_ENV=development

# SQL Server Configuration
DB_SERVER=localhost
DB_DATABASE=AlphaDigiwallet
DB_USER=your_db_user
DB_PASSWORD=your_db_password
DB_PORT=1433

# JWT Secret
JWT_SECRET=your_super_secret_jwt_key_change_this_in_production

# Session Secret
SESSION_SECRET=your_super_secret_session_key_change_this_in_production

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">server.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>require('dotenv').config();
const app = require('./src/app');
const logger = require('./src/config/logger');

const PORT = process.env.PORT || 3000;

app.listen(PORT, () => {
  logger.info(`üöÄ Alpha Digiwallet API running on port ${PORT}`);
  logger.info(`üìç Environment: ${process.env.NODE_ENV}`);
  logger.info(`üîó API Base URL: http://localhost:${PORT}/api`);
});</pre>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div class="tab-content" data-tab-content="config">
                <div class="code-block">
                    <div class="file-header">src/config/database.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const sql = require('mssql');
const logger = require('./logger');

const config = {
  server: process.env.DB_SERVER,
  database: process.env.DB_DATABASE,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  port: parseInt(process.env.DB_PORT || '1433'),
  options: {
    encrypt: true,
    trustServerCertificate: true,
    enableArithAbort: true
  },
  pool: {
    max: 10,
    min: 0,
    idleTimeoutMillis: 30000
  }
};

let pool;

async function getConnection() {
  try {
    if (!pool) {
      pool = await sql.connect(config);
      logger.info('‚úÖ SQL Server connection established');
    }
    return pool;
  } catch (err) {
    logger.error('‚ùå Database connection error:', err);
    throw err;
  }
}

module.exports = { getConnection, sql };</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/config/config.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>module.exports = {
  port: process.env.PORT || 3000,
  nodeEnv: process.env.NODE_ENV || 'development',
  
  jwt: {
    secret: process.env.JWT_SECRET,
    expiresIn: '24h'
  },
  
  session: {
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: process.env.NODE_ENV === 'production',
      httpOnly: true,
      maxAge: 24 * 60 * 60 * 1000 // 24 hours
    }
  },
  
  rateLimit: {
    windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS || '900000'),
    max: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS || '100')
  },
  
  wallet: {
    defaultCurrency: 'USD',
    initialBalance: 0
  }
};</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/config/logger.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const winston = require('winston');

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || 'info',
  format: winston.format.combine(
    winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
    winston.format.errors({ stack: true }),
    winston.format.splat(),
    winston.format.json()
  ),
  defaultMeta: { service: 'alpha-digiwallet' },
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' })
  ]
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.combine(
      winston.format.colorize(),
      winston.format.simple()
    )
  }));
}

module.exports = logger;</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/app.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const express = require('express');
const helmet = require('helmet');
const cors = require('cors');
const bodyParser = require('body-parser');
const session = require('express-session');
const rateLimit = require('express-rate-limit');
const config = require('./config/config');
const errorHandler = require('./middleware/errorHandler');
const logger = require('./config/logger');

// Import routes
const authRoutes = require('./routes/auth');
const walletRoutes = require('./routes/wallet');
const transactionRoutes = require('./routes/transaction');
const merchantRoutes = require('./routes/merchant');
const adminRoutes = require('./routes/admin');

const app = express();

// Security middleware
app.use(helmet());
app.use(cors());

// Rate limiting
const limiter = rateLimit(config.rateLimit);
app.use('/api/', limiter);

// Body parsing
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// Session
app.use(session(config.session));

// Request logging
app.use((req, res, next) => {
  logger.info(`${req.method} ${req.path}`);
  next();
});

// Health check
app.get('/health', (req, res) => {
  res.json({ status: 'healthy', timestamp: new Date().toISOString() });
});

// API routes
app.use('/api/auth', authRoutes);
app.use('/api/wallet', walletRoutes);
app.use('/api/transactions', transactionRoutes);
app.use('/api/merchants', merchantRoutes);
app.use('/api/admin', adminRoutes);

// 404 handler
app.use((req, res) => {
  res.status(404).json({ error: 'Endpoint not found' });
});

// Error handler
app.use(errorHandler);

module.exports = app;</pre>
                </div>
            </div>

            <!-- Models Tab -->
            <div class="tab-content" data-tab-content="models">
                <div class="code-block">
                    <div class="file-header">src/models/User.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const { getConnection, sql } = require('../config/database');
const bcrypt = require('bcryptjs');

class User {
  static async create({ email, password, firstName, lastName, phone }) {
    const pool = await getConnection();
    const hashedPassword = await bcrypt.hash(password, 10);
    
    const result = await pool.request()
      .input('email', sql.VarChar, email)
      .input('password', sql.VarChar, hashedPassword)
      .input('firstName', sql.VarChar, firstName)
      .input('lastName', sql.VarChar, lastName)
      .input('phone', sql.VarChar, phone)
      .query(`
        INSERT INTO Users (email, password, first_name, last_name, phone, role, status)
        OUTPUT INSERTED.*
        VALUES (@email, @password, @firstName, @lastName, @phone, 'user', 'active')
      `);
    
    return result.recordset[0];
  }

  static async findByEmail(email) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('email', sql.VarChar, email)
      .query('SELECT * FROM Users WHERE email = @email');
    
    return result.recordset[0];
  }

  static async findById(userId) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('userId', sql.UniqueIdentifier, userId)
      .query('SELECT * FROM Users WHERE user_id = @userId');
    
    return result.recordset[0];
  }

  static async verifyPassword(plainPassword, hashedPassword) {
    return bcrypt.compare(plainPassword, hashedPassword);
  }

  static async updateLastLogin(userId) {
    const pool = await getConnection();
    await pool.request()
      .input('userId', sql.UniqueIdentifier, userId)
      .query('UPDATE Users SET last_login = GETDATE() WHERE user_id = @userId');
  }
}

module.exports = User;</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/models/Wallet.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const { getConnection, sql } = require('../config/database');

class Wallet {
  static async create(userId, currency = 'USD') {
    const pool = await getConnection();
    
    const result = await pool.request()
      .input('userId', sql.UniqueIdentifier, userId)
      .input('currency', sql.VarChar, currency)
      .query(`
        INSERT INTO Wallets (user_id, balance, currency, status)
        OUTPUT INSERTED.*
        VALUES (@userId, 0.00, @currency, 'active')
      `);
    
    return result.recordset[0];
  }

  static async findByUserId(userId) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('userId', sql.UniqueIdentifier, userId)
      .query('SELECT * FROM Wallets WHERE user_id = @userId');
    
    return result.recordset[0];
  }

  static async findById(walletId) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('walletId', sql.UniqueIdentifier, walletId)
      .query('SELECT * FROM Wallets WHERE wallet_id = @walletId');
    
    return result.recordset[0];
  }

  static async updateBalance(walletId, amount, operation = 'credit') {
    const pool = await getConnection();
    const transaction = pool.transaction();
    
    try {
      await transaction.begin();
      
      // Get current balance with lock
      const balanceResult = await transaction.request()
        .input('walletId', sql.UniqueIdentifier, walletId)
        .query('SELECT balance FROM Wallets WITH (UPDLOCK) WHERE wallet_id = @walletId');
      
      const currentBalance = balanceResult.recordset[0].balance;
      const newBalance = operation === 'credit' 
        ? parseFloat(currentBalance) + parseFloat(amount)
        : parseFloat(currentBalance) - parseFloat(amount);
      
      if (newBalance < 0) {
        throw new Error('Insufficient balance');
      }
      
      // Update balance
      await transaction.request()
        .input('walletId', sql.UniqueIdentifier, walletId)
        .input('newBalance', sql.Decimal(18, 2), newBalance)
        .query('UPDATE Wallets SET balance = @newBalance, updated_at = GETDATE() WHERE wallet_id = @walletId');
      
      await transaction.commit();
      return newBalance;
    } catch (err) {
      await transaction.rollback();
      throw err;
    }
  }

  static async getBalance(walletId) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('walletId', sql.UniqueIdentifier, walletId)
      .query('SELECT balance FROM Wallets WHERE wallet_id = @walletId');
    
    return result.recordset[0]?.balance || 0;
  }
}

module.exports = Wallet;</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/models/Transaction.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const { getConnection, sql } = require('../config/database');

class Transaction {
  static async create({
    fromWalletId,
    toWalletId,
    amount,
    type,
    status = 'pending',
    reference,
    description
  }) {
    const pool = await getConnection();
    
    const result = await pool.request()
      .input('fromWalletId', sql.UniqueIdentifier, fromWalletId)
      .input('toWalletId', sql.UniqueIdentifier, toWalletId)
      .input('amount', sql.Decimal(18, 2), amount)
      .input('type', sql.VarChar, type)
      .input('status', sql.VarChar, status)
      .input('reference', sql.VarChar, reference)
      .input('description', sql.VarChar, description)
      .query(`
        INSERT INTO Transactions (from_wallet_id, to_wallet_id, amount, type, status, reference, description)
        OUTPUT INSERTED.*
        VALUES (@fromWalletId, @toWalletId, @amount, @type, @status, @reference, @description)
      `);
    
    return result.recordset[0];
  }

  static async findById(transactionId) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('transactionId', sql.UniqueIdentifier, transactionId)
      .query('SELECT * FROM Transactions WHERE transaction_id = @transactionId');
    
    return result.recordset[0];
  }

  static async updateStatus(transactionId, status, errorMessage = null) {
    const pool = await getConnection();
    
    await pool.request()
      .input('transactionId', sql.UniqueIdentifier, transactionId)
      .input('status', sql.VarChar, status)
      .input('errorMessage', sql.VarChar, errorMessage)
      .query(`
        UPDATE Transactions 
        SET status = @status, 
            error_message = @errorMessage,
            updated_at = GETDATE()
        WHERE transaction_id = @transactionId
      `);
  }

  static async getByWalletId(walletId, limit = 50) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('walletId', sql.UniqueIdentifier, walletId)
      .input('limit', sql.Int, limit)
      .query(`
        SELECT TOP (@limit) * FROM Transactions 
        WHERE from_wallet_id = @walletId OR to_wallet_id = @walletId
        ORDER BY created_at DESC
      `);
    
    return result.recordset;
  }

  static async getAll(limit = 100, offset = 0) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('limit', sql.Int, limit)
      .input('offset', sql.Int, offset)
      .query(`
        SELECT * FROM Transactions 
        ORDER BY created_at DESC
        OFFSET @offset ROWS
        FETCH NEXT @limit ROWS ONLY
      `);
    
    return result.recordset;
  }
}

module.exports = Transaction;</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/models/Merchant.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const { getConnection, sql } = require('../config/database');

class Merchant {
  static async create({
    userId,
    businessName,
    businessType,
    registrationNumber,
    contactEmail,
    contactPhone
  }) {
    const pool = await getConnection();
    
    const result = await pool.request()
      .input('userId', sql.UniqueIdentifier, userId)
      .input('businessName', sql.VarChar, businessName)
      .input('businessType', sql.VarChar, businessType)
      .input('registrationNumber', sql.VarChar, registrationNumber)
      .input('contactEmail', sql.VarChar, contactEmail)
      .input('contactPhone', sql.VarChar, contactPhone)
      .query(`
        INSERT INTO Merchants (user_id, business_name, business_type, registration_number, 
                               contact_email, contact_phone, status)
        OUTPUT INSERTED.*
        VALUES (@userId, @businessName, @businessType, @registrationNumber, 
                @contactEmail, @contactPhone, 'pending')
      `);
    
    return result.recordset[0];
  }

  static async findByUserId(userId) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('userId', sql.UniqueIdentifier, userId)
      .query('SELECT * FROM Merchants WHERE user_id = @userId');
    
    return result.recordset[0];
  }

  static async findById(merchantId) {
    const pool = await getConnection();
    const result = await pool.request()
      .input('merchantId', sql.UniqueIdentifier, merchantId)
      .query('SELECT * FROM Merchants WHERE merchant_id = @merchantId');
    
    return result.recordset[0];
  }

  static async updateStatus(merchantId, status) {
    const pool = await getConnection();
    
    await pool.request()
      .input('merchantId', sql.UniqueIdentifier, merchantId)
      .input('status', sql.VarChar, status)
      .query(`
        UPDATE Merchants 
        SET status = @status, updated_at = GETDATE()
        WHERE merchant_id = @merchantId
      `);
  }

  static async getAll(status = null) {
    const pool = await getConnection();
    
    let query = 'SELECT * FROM Merchants';
    if (status) {
      query += ' WHERE status = @status';
    }
    query += ' ORDER BY created_at DESC';
    
    const request = pool.request();
    if (status) {
      request.input('status', sql.VarChar, status);
    }
    
    const result = await request.query(query);
    return result.recordset;
  }
}

module.exports = Merchant;</pre>
                </div>
            </div>

            <!-- Middleware Tab -->
            <div class="tab-content" data-tab-content="middleware">
                <div class="code-block">
                    <div class="file-header">src/middleware/auth.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const jwt = require('jsonwebtoken');
const config = require('../config/config');

const authenticate = (req, res, next) => {
  try {
    const token = req.headers.authorization?.split(' ')[1];
    
    if (!token) {
      return res.status(401).json({ error: 'No token provided' });
    }
    
    const decoded = jwt.verify(token, config.jwt.secret);
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid or expired token' });
  }
};

const authorize = (...roles) => {
  return (req, res, next) => {
    if (!req.user) {
      return res.status(401).json({ error: 'Unauthorized' });
    }
    
    if (!roles.includes(req.user.role)) {
      return res.status(403).json({ error: 'Forbidden: Insufficient permissions' });
    }
    
    next();
  };
};

module.exports = { authenticate, authorize };</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/middleware/validation.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const Joi = require('joi');

const validate = (schema) => {
  return (req, res, next) => {
    const { error } = schema.validate(req.body, { abortEarly: false });
    
    if (error) {
      const errors = error.details.map(detail => ({
        field: detail.path.join('.'),
        message: detail.message
      }));
      
      return res.status(400).json({ 
        error: 'Validation failed',
        details: errors 
      });
    }
    
    next();
  };
};

const schemas = {
  register: Joi.object({
    email: Joi.string().email().required(),
    password: Joi.string().min(8).required(),
    firstName: Joi.string().required(),
    lastName: Joi.string().required(),
    phone: Joi.string().required()
  }),
  
  login: Joi.object({
    email: Joi.string().email().required(),
    password: Joi.string().required()
  }),
  
  transfer: Joi.object({
    toWalletId: Joi.string().uuid().required(),
    amount: Joi.number().positive().required(),
    description: Joi.string().optional()
  }),
  
  topup: Joi.object({
    amount: Joi.number().positive().required(),
    paymentMethod: Joi.string().required()
  }),
  
  merchantRegistration: Joi.object({
    businessName: Joi.string().required(),
    businessType: Joi.string().required(),
    registrationNumber: Joi.string().required(),
    contactEmail: Joi.string().email().required(),
    contactPhone: Joi.string().required()
  })
};

module.exports = { validate, schemas };</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/middleware/errorHandler.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const logger = require('../config/logger');

const errorHandler = (err, req, res, next) => {
  logger.error('Error:', {
    message: err.message,
    stack: err.stack,
    path: req.path,
    method: req.method
  });

  // SQL Server errors
  if (err.number) {
    if (err.number === 2627 || err.number === 2601) {
      return res.status(409).json({ 
        error: 'Duplicate entry',
        message: 'This record already exists'
      });
    }
  }

  // JWT errors
  if (err.name === 'JsonWebTokenError') {
    return res.status(401).json({ error: 'Invalid token' });
  }
  
  if (err.name === 'TokenExpiredError') {
    return res.status(401).json({ error: 'Token expired' });
  }

  // Default error
  res.status(err.statusCode || 500).json({
    error: err.message || 'Internal server error',
    ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
  });
};

module.exports = errorHandler;</pre>
                </div>
            </div>

            <!-- Controllers Tab -->
            <div class="tab-content" data-tab-content="controllers">
                <div class="code-block">
                    <div class="file-header">src/controllers/authController.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const jwt = require('jsonwebtoken');
const User = require('../models/User');
const Wallet = require('../models/Wallet');
const config = require('../config/config');
const logger = require('../config/logger');

exports.register = async (req, res, next) => {
  try {
    const { email, password, firstName, lastName, phone } = req.body;
    
    // Check if user exists
    const existingUser = await User.findByEmail(email);
    if (existingUser) {
      return res.status(409).json({ error: 'Email already registered' });
    }
    
    // Create user
    const user = await User.create({ email, password, firstName, lastName, phone });
    
    // Create wallet for user
    await Wallet.create(user.user_id);
    
    logger.info(`New user registered: ${email}`);
    
    res.status(201).json({
      message: 'User registered successfully',
      userId: user.user_id
    });
  } catch (error) {
    next(error);
  }
};

exports.login = async (req, res, next) => {
  try {
    const { email, password } = req.body;
    
    // Find user
    const user = await User.findByEmail(email);
    if (!user) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    // Verify password
    const isValidPassword = await User.verifyPassword(password, user.password);
    if (!isValidPassword) {
      return res.status(401).json({ error: 'Invalid credentials' });
    }
    
    // Update last login
    await User.updateLastLogin(user.user_id);
    
    // Generate JWT
    const token = jwt.sign(
      { 
        userId: user.user_id,
        email: user.email,
        role: user.role
      },
      config.jwt.secret,
      { expiresIn: config.jwt.expiresIn }
    );
    
    logger.info(`User logged in: ${email}`);
    
    res.json({
      token,
      user: {
        userId: user.user_id,
        email: user.email,
        firstName: user.first_name,
        lastName: user.last_name,
        role: user.role
      }
    });
  } catch (error) {
    next(error);
  }
};

exports.getProfile = async (req, res, next) => {
  try {
    const user = await User.findById(req.user.userId);
    
    if (!user) {
      return res.status(404).json({ error: 'User not found' });
    }
    
    // Remove password from response
    delete user.password;
    
    res.json(user);
  } catch (error) {
    next(error);
  }
};</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/controllers/walletController.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const Wallet = require('../models/Wallet');
const Transaction = require('../models/Transaction');
const walletService = require('../services/walletService');
const logger = require('../config/logger');

exports.getWallet = async (req, res, next) => {
  try {
    const wallet = await Wallet.findByUserId(req.user.userId);
    
    if (!wallet) {
      return res.status(404).json({ error: 'Wallet not found' });
    }
    
    res.json({
      walletId: wallet.wallet_id,
      balance: parseFloat(wallet.balance),
      currency: wallet.currency,
      status: wallet.status
    });
  } catch (error) {
    next(error);
  }
};

exports.getBalance = async (req, res, next) => {
  try {
    const wallet = await Wallet.findByUserId(req.user.userId);
    
    if (!wallet) {
      return res.status(404).json({ error: 'Wallet not found' });
    }
    
    const balance = await Wallet.getBalance(wallet.wallet_id);
    
    res.json({
      balance: parseFloat(balance),
      currency: wallet.currency
    });
  } catch (error) {
    next(error);
  }
};

exports.topup = async (req, res, next) => {
  try {
    const { amount, paymentMethod } = req.body;
    const wallet = await Wallet.findByUserId(req.user.userId);
    
    if (!wallet) {
      return res.status(404).json({ error: 'Wallet not found' });
    }
    
    // Simulate PSP topup
    const result = await walletService.processTopup(wallet.wallet_id, amount, paymentMethod);
    
    logger.info(`Topup processed: ${amount} for user ${req.user.userId}`);
    
    res.json(result);
  } catch (error) {
    next(error);
  }
};</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/controllers/transactionController.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const Transaction = require('../models/Transaction');
const Wallet = require('../models/Wallet');
const transactionService = require('../services/transactionService');
const logger = require('../config/logger');

exports.transfer = async (req, res, next) => {
  try {
    const { toWalletId, amount, description } = req.body;
    
    // Get sender wallet
    const fromWallet = await Wallet.findByUserId(req.user.userId);
    if (!fromWallet) {
      return res.status(404).json({ error: 'Wallet not found' });
    }
    
    // Verify recipient wallet exists
    const toWallet = await Wallet.findById(toWalletId);
    if (!toWallet) {
      return res.status(404).json({ error: 'Recipient wallet not found' });
    }
    
    // Check if trying to transfer to self
    if (fromWallet.wallet_id === toWalletId) {
      return res.status(400).json({ error: 'Cannot transfer to your own wallet' });
    }
    
    // Process transfer
    const result = await transactionService.processTransfer({
      fromWalletId: fromWallet.wallet_id,
      toWalletId,
      amount,
      description
    });
    
    logger.info(`Transfer completed: ${amount} from ${fromWallet.wallet_id} to ${toWalletId}`);
    
    res.json(result);
  } catch (error) {
    next(error);
  }
};

exports.getTransactions = async (req, res, next) => {
  try {
    const wallet = await Wallet.findByUserId(req.user.userId);
    
    if (!wallet) {
      return res.status(404).json({ error: 'Wallet not found' });
    }
    
    const limit = parseInt(req.query.limit) || 50;
    const transactions = await Transaction.getByWalletId(wallet.wallet_id, limit);
    
    res.json({
      transactions: transactions.map(t => ({
        transactionId: t.transaction_id,
        fromWalletId: t.from_wallet_id,
        toWalletId: t.to_wallet_id,
        amount: parseFloat(t.amount),
        type: t.type,
        status: t.status,
        reference: t.reference,
        description: t.description,
        createdAt: t.created_at
      }))
    });
  } catch (error) {
    next(error);
  }
};

exports.getTransactionById = async (req, res, next) => {
  try {
    const { transactionId } = req.params;
    const transaction = await Transaction.findById(transactionId);
    
    if (!transaction) {
      return res.status(404).json({ error: 'Transaction not found' });
    }
    
    // Verify user owns this transaction
    const wallet = await Wallet.findByUserId(req.user.userId);
    if (transaction.from_wallet_id !== wallet.wallet_id && 
        transaction.to_wallet_id !== wallet.wallet_id) {
      return res.status(403).json({ error: 'Unauthorized' });
    }
    
    res.json({
      transactionId: transaction.transaction_id,
      fromWalletId: transaction.from_wallet_id,
      toWalletId: transaction.to_wallet_id,
      amount: parseFloat(transaction.amount),
      type: transaction.type,
      status: transaction.status,
      reference: transaction.reference,
      description: transaction.description,
      createdAt: transaction.created_at
    });
  } catch (error) {
    next(error);
  }
};</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/controllers/merchantController.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const Merchant = require('../models/Merchant');
const Wallet = require('../models/Wallet');
const logger = require('../config/logger');

exports.registerMerchant = async (req, res, next) => {
  try {
    const { businessName, businessType, registrationNumber, contactEmail, contactPhone } = req.body;
    
    // Check if user already has merchant account
    const existingMerchant = await Merchant.findByUserId(req.user.userId);
    if (existingMerchant) {
      return res.status(409).json({ error: 'Merchant account already exists' });
    }
    
    // Create merchant
    const merchant = await Merchant.create({
      userId: req.user.userId,
      businessName,
      businessType,
      registrationNumber,
      contactEmail,
      contactPhone
    });
    
    logger.info(`New merchant registered: ${businessName}`);
    
    res.status(201).json({
      message: 'Merchant registration submitted for approval',
      merchantId: merchant.merchant_id,
      status: merchant.status
    });
  } catch (error) {
    next(error);
  }
};

exports.getMerchantProfile = async (req, res, next) => {
  try {
    const merchant = await Merchant.findByUserId(req.user.userId);
    
    if (!merchant) {
      return res.status(404).json({ error: 'Merchant account not found' });
    }
    
    // Get merchant wallet
    const wallet = await Wallet.findByUserId(req.user.userId);
    
    res.json({
      merchantId: merchant.merchant_id,
      businessName: merchant.business_name,
      businessType: merchant.business_type,
      registrationNumber: merchant.registration_number,
      contactEmail: merchant.contact_email,
      contactPhone: merchant.contact_phone,
      status: merchant.status,
      wallet: wallet ? {
        walletId: wallet.wallet_id,
        balance: parseFloat(wallet.balance),
        currency: wallet.currency
      } : null,
      createdAt: merchant.created_at
    });
  } catch (error) {
    next(error);
  }
};</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/controllers/adminController.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const User = require('../models/User');
const Wallet = require('../models/Wallet');
const Transaction = require('../models/Transaction');
const Merchant = require('../models/Merchant');
const { getConnection, sql } = require('../config/database');

exports.getAllUsers = async (req, res, next) => {
  try {
    const pool = await getConnection();
    const result = await pool.request().query(`
      SELECT 
        u.user_id, u.email, u.first_name, u.last_name, u.phone, 
        u.role, u.status, u.created_at, u.last_login,
        w.wallet_id, w.balance, w.currency
      FROM Users u
      LEFT JOIN Wallets w ON u.user_id = w.user_id
      ORDER BY u.created_at DESC
    `);
    
    res.json({ users: result.recordset });
  } catch (error) {
    next(error);
  }
};

exports.getAllTransactions = async (req, res, next) => {
  try {
    const limit = parseInt(req.query.limit) || 100;
    const offset = parseInt(req.query.offset) || 0;
    
    const transactions = await Transaction.getAll(limit, offset);
    
    res.json({
      transactions: transactions.map(t => ({
        transactionId: t.transaction_id,
        fromWalletId: t.from_wallet_id,
        toWalletId: t.to_wallet_id,
        amount: parseFloat(t.amount),
        type: t.type,
        status: t.status,
        reference: t.reference,
        description: t.description,
        createdAt: t.created_at
      })),
      pagination: { limit, offset }
    });
  } catch (error) {
    next(error);
  }
};

exports.getAllMerchants = async (req, res, next) => {
  try {
    const status = req.query.status;
    const merchants = await Merchant.getAll(status);
    
    res.json({ merchants });
  } catch (error) {
    next(error);
  }
};

exports.approveMerchant = async (req, res, next) => {
  try {
    const { merchantId } = req.params;
    
    const merchant = await Merchant.findById(merchantId);
    if (!merchant) {
      return res.status(404).json({ error: 'Merchant not found' });
    }
    
    await Merchant.updateStatus(merchantId, 'active');
    
    res.json({ message: 'Merchant approved successfully' });
  } catch (error) {
    next(error);
  }
};

exports.rejectMerchant = async (req, res, next) => {
  try {
    const { merchantId } = req.params;
    
    const merchant = await Merchant.findById(merchantId);
    if (!merchant) {
      return res.status(404).json({ error: 'Merchant not found' });
    }
    
    await Merchant.updateStatus(merchantId, 'rejected');
    
    res.json({ message: 'Merchant rejected' });
  } catch (error) {
    next(error);
  }
};

exports.getDashboardStats = async (req, res, next) => {
  try {
    const pool = await getConnection();
    
    const stats = await pool.request().query(`
      SELECT 
        (SELECT COUNT(*) FROM Users) as totalUsers,
        (SELECT COUNT(*) FROM Wallets) as totalWallets,
        (SELECT COUNT(*) FROM Transactions) as totalTransactions,
        (SELECT COUNT(*) FROM Merchants WHERE status = 'active') as activeMerchants,
        (SELECT SUM(balance) FROM Wallets) as totalBalance
    `);
    
    res.json(stats.recordset[0]);
  } catch (error) {
    next(error);
  }
};</pre>
                </div>
            </div>

            <!-- Routes Tab -->
            <div class="tab-content" data-tab-content="routes">
                <div class="code-block">
                    <div class="file-header">src/routes/auth.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const express = require('express');
const router = express.Router();
const authController = require('../controllers/authController');
const { authenticate } = require('../middleware/auth');
const { validate, schemas } = require('../middleware/validation');

// Public routes
router.post('/register', validate(schemas.register), authController.register);
router.post('/login', validate(schemas.login), authController.login);

// Protected routes
router.get('/profile', authenticate, authController.getProfile);

module.exports = router;</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/routes/wallet.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const express = require('express');
const router = express.Router();
const walletController = require('../controllers/walletController');
const { authenticate } = require('../middleware/auth');
const { validate, schemas } = require('../middleware/validation');

// All wallet routes require authentication
router.use(authenticate);

router.get('/', walletController.getWallet);
router.get('/balance', walletController.getBalance);
router.post('/topup', validate(schemas.topup), walletController.topup);

module.exports = router;</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/routes/transaction.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const express = require('express');
const router = express.Router();
const transactionController = require('../controllers/transactionController');
const { authenticate } = require('../middleware/auth');
const { validate, schemas } = require('../middleware/validation');

// All transaction routes require authentication
router.use(authenticate);

router.post('/transfer', validate(schemas.transfer), transactionController.transfer);
router.get('/', transactionController.getTransactions);
router.get('/:transactionId', transactionController.getTransactionById);

module.exports = router;</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/routes/merchant.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const express = require('express');
const router = express.Router();
const merchantController = require('../controllers/merchantController');
const { authenticate } = require('../middleware/auth');
const { validate, schemas } = require('../middleware/validation');

// All merchant routes require authentication
router.use(authenticate);

router.post('/register', validate(schemas.merchantRegistration), merchantController.registerMerchant);
router.get('/profile', merchantController.getMerchantProfile);

module.exports = router;</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/routes/admin.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const express = require('express');
const router = express.Router();
const adminController = require('../controllers/adminController');
const { authenticate, authorize } = require('../middleware/auth');

// All admin routes require admin authentication
router.use(authenticate);
router.use(authorize('admin'));

router.get('/users', adminController.getAllUsers);
router.get('/transactions', adminController.getAllTransactions);
router.get('/merchants', adminController.getAllMerchants);
router.post('/merchants/:merchantId/approve', adminController.approveMerchant);
router.post('/merchants/:merchantId/reject', adminController.rejectMerchant);
router.get('/dashboard/stats', adminController.getDashboardStats);

module.exports = router;</pre>
                </div>
            </div>

            <!-- Services Tab -->
            <div class="tab-content" data-tab-content="services">
                <div class="code-block">
                    <div class="file-header">src/services/walletService.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const Wallet = require('../models/Wallet');
const Transaction = require('../models/Transaction');
const pspSimulator = require('./pspSimulator');
const { v4: uuidv4 } = require('uuid');

exports.processTopup = async (walletId, amount, paymentMethod) => {
  try {
    // Simulate PSP payment processing
    const pspResult = await pspSimulator.processPayment({
      amount,
      paymentMethod,
      currency: 'USD'
    });
    
    if (!pspResult.success) {
      throw new Error('Payment processing failed');
    }
    
    // Create transaction record
    const transaction = await Transaction.create({
      fromWalletId: null,
      toWalletId: walletId,
      amount,
      type: 'topup',
      status: 'pending',
      reference: pspResult.referenceId,
      description: `Topup via ${paymentMethod}`
    });
    
    // Update wallet balance
    const newBalance = await Wallet.updateBalance(walletId, amount, 'credit');
    
    // Update transaction status
    await Transaction.updateStatus(transaction.transaction_id, 'completed');
    
    return {
      success: true,
      transactionId: transaction.transaction_id,
      amount: parseFloat(amount),
      newBalance: parseFloat(newBalance),
      reference: pspResult.referenceId
    };
  } catch (error) {
    if (transaction) {
      await Transaction.updateStatus(transaction.transaction_id, 'failed', error.message);
    }
    throw error;
  }
};</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/services/transactionService.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const Wallet = require('../models/Wallet');
const Transaction = require('../models/Transaction');
const { v4: uuidv4 } = require('uuid');

exports.processTransfer = async ({ fromWalletId, toWalletId, amount, description }) => {
  let transaction;
  
  try {
    // Create transaction record
    transaction = await Transaction.create({
      fromWalletId,
      toWalletId,
      amount,
      type: 'transfer',
      status: 'pending',
      reference: uuidv4(),
      description: description || 'Wallet transfer'
    });
    
    // Check sender balance
    const senderBalance = await Wallet.getBalance(fromWalletId);
    if (parseFloat(senderBalance) < parseFloat(amount)) {
      throw new Error('Insufficient balance');
    }
    
    // Debit sender
    await Wallet.updateBalance(fromWalletId, amount, 'debit');
    
    // Credit recipient
    await Wallet.updateBalance(toWalletId, amount, 'credit');
    
    // Update transaction status
    await Transaction.updateStatus(transaction.transaction_id, 'completed');
    
    // Get updated balances
    const newSenderBalance = await Wallet.getBalance(fromWalletId);
    const newRecipientBalance = await Wallet.getBalance(toWalletId);
    
    return {
      success: true,
      transactionId: transaction.transaction_id,
      amount: parseFloat(amount),
      senderBalance: parseFloat(newSenderBalance),
      recipientBalance: parseFloat(newRecipientBalance),
      reference: transaction.reference
    };
  } catch (error) {
    if (transaction) {
      await Transaction.updateStatus(transaction.transaction_id, 'failed', error.message);
    }
    throw error;
  }
};</pre>
                </div>

                <div class="code-block">
                    <div class="file-header">src/services/pspSimulator.js</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>const { v4: uuidv4 } = require('uuid');

/**
 * PSP Simulator - Simulates payment gateway responses
 * Replace with actual PSP integration in production
 */

exports.processPayment = async ({ amount, paymentMethod, currency }) => {
  // Simulate API delay
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // Simulate 95% success rate
  const isSuccess = Math.random() > 0.05;
  
  if (isSuccess) {
    return {
      success: true,
      referenceId: `PSP-${uuidv4()}`,
      amount,
      currency,
      paymentMethod,
      timestamp: new Date().toISOString()
    };
  } else {
    return {
      success: false,
      error: 'Payment declined by issuer',
      referenceId: `PSP-${uuidv4()}`,
      timestamp: new Date().toISOString()
    };
  }
};

exports.processRefund = async ({ transactionId, amount }) => {
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  return {
    success: true,
    refundId: `REF-${uuidv4()}`,
    amount,
    timestamp: new Date().toISOString()
  };
};</pre>
                </div>
            </div>

            <!-- Database Tab -->
            <div class="tab-content" data-tab-content="database">
                <div class="code-block">
                    <div class="file-header">database/schema.sql</div>
                    <button class="copy-btn" onclick="copyCode(this)">Copy</button>
                    <pre>-- Alpha Digiwallet Database Schema
-- SQL Server

-- Users Table
CREATE TABLE Users (
    user_id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    email VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user', -- user, merchant, admin
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active, suspended, closed
    created_at DATETIME NOT NULL DEFAULT GETDATE(),
    updated_at DATETIME NOT NULL DEFAULT GETDATE(),
    last_login DATETIME
);

-- Wallets Table
CREATE TABLE Wallets (
    wallet_id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    user_id UNIQUEIDENTIFIER NOT NULL,
    balance DECIMAL(18, 2) NOT NULL DEFAULT 0.00,
    currency VARCHAR(3) NOT NULL DEFAULT 'USD',
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- active, frozen, closed
    created_at DATETIME NOT NULL DEFAULT GETDATE(),
    updated_at DATETIME NOT NULL DEFAULT GETDATE(),
    FOREIGN KEY (user_id) REFERENCES Users(user_id),
    CONSTRAINT CHK_Balance CHECK (balance >= 0)
);

-- Transactions Table
CREATE TABLE Transactions (
    transaction_id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    from_wallet_id UNIQUEIDENTIFIER,
    to_wallet_id UNIQUEIDENTIFIER,
    amount DECIMAL(18, 2) NOT NULL,
    type VARCHAR(20) NOT NULL, -- topup, transfer, payment, refund, withdrawal
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, completed, failed, cancelled
    reference VARCHAR(255) NOT NULL,
    description VARCHAR(500),
    error_message VARCHAR(500),
    created_at DATETIME NOT NULL DEFAULT GETDATE(),
    updated_at DATETIME NOT NULL DEFAULT GETDATE(),
    FOREIGN KEY (from_wallet_id) REFERENCES Wallets(wallet_id),
    FOREIGN KEY (to_wallet_id) REFERENCES Wallets(wallet_id),
    CONSTRAINT CHK_Amount CHECK (amount > 0)
);

-- Merchants Table
CREATE TABLE Merchants (
    merchant_id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    user_id UNIQUEIDENTIFIER NOT NULL,
    business_name VARCHAR(255) NOT NULL,
    business_type VARCHAR(100) NOT NULL,
    registration_number VARCHAR(100) NOT NULL,
    contact_email VARCHAR(255) NOT NULL,
    contact_phone VARCHAR(20) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, active, suspended, rejected
    created_at DATETIME NOT NULL DEFAULT GETDATE(),
    updated_at DATETIME NOT NULL DEFAULT GETDATE(),
    FOREIGN KEY (user_id) REFERENCES Users(user_id)
);

-- Create indexes for better performance
CREATE INDEX IDX_Users_Email ON Users(email);
CREATE INDEX IDX_Wallets_UserId ON Wallets(user_id);
CREATE INDEX IDX_Transactions_FromWallet ON Transactions(from_wallet_id);
CREATE INDEX IDX_Transactions_ToWallet ON Transactions(to_wallet_id);
CREATE INDEX IDX_Transactions_Status ON Transactions(status);
CREATE INDEX IDX_Transactions_CreatedAt ON Transactions(created_at DESC);
CREATE INDEX IDX_Merchants_UserId ON Merchants(user_id);
CREATE INDEX IDX_Merchants_Status ON Merchants(status);

-- Create logs directory trigger (optional - for audit trail)
-- You can add audit logging tables here if needed

-- Insert default admin user (password: Admin@123)
INSERT INTO Users (email, password, first_name, last_name, phone, role, status)
VALUES (
    'admin@alphadigiwallet.com',
    '$2a$10$XxXxXxXxXxXxXxXxXxXxXuYrE8h3E7K8h3E7K8h3E7K8h3E7K8h3E7', -- bcrypt hash of 'Admin@123'
    'System',
    'Administrator',
    '+971501234567',
    'admin',
    'active'
);

PRINT 'Database schema created successfully';</pre>
                </div>
            </div>
        </div>

        <!-- API Endpoints Section -->
        <div class="section">
            <h2>üîå API Endpoints Reference</h2>
            
            <h3>Authentication</h3>
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="endpoint-path">/api/auth/register</span>
                </div>
                <div class="endpoint-desc">Register new user and create wallet</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="endpoint-path">/api/auth/login</span>
                </div>
                <div class="endpoint-desc">Login and receive JWT token</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/auth/profile</span>
                </div>
                <div class="endpoint-desc">Get authenticated user profile</div>
            </div>

            <h3>Wallet</h3>
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/wallet</span>
                </div>
                <div class="endpoint-desc">Get wallet details</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/wallet/balance</span>
                </div>
                <div class="endpoint-desc">Get current balance</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="endpoint-path">/api/wallet/topup</span>
                </div>
                <div class="endpoint-desc">Top up wallet (PSP simulation)</div>
            </div>

            <h3>Transactions</h3>
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="endpoint-path">/api/transactions/transfer</span>
                </div>
                <div class="endpoint-desc">Transfer funds to another wallet</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/transactions</span>
                </div>
                <div class="endpoint-desc">Get user transaction history</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/transactions/:id</span>
                </div>
                <div class="endpoint-desc">Get specific transaction details</div>
            </div>

            <h3>Merchants</h3>
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="endpoint-path">/api/merchants/register</span>
                </div>
                <div class="endpoint-desc">Register as merchant</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/merchants/profile</span>
                </div>
                <div class="endpoint-desc">Get merchant profile and wallet</div>
            </div>

            <h3>Admin (Requires admin role)</h3>
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/admin/users</span>
                </div>
                <div class="endpoint-desc">List all users</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/admin/transactions</span>
                </div>
                <div class="endpoint-desc">List all transactions</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/admin/merchants</span>
                </div>
                <div class="endpoint-desc">List all merchants</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method post">POST</span>
                    <span class="endpoint-path">/api/admin/merchants/:id/approve</span>
                </div>
                <div class="endpoint-desc">Approve merchant registration</div>
            </div>
            
            <div class="endpoint-card">
                <div class="endpoint-header">
                    <span class="method get">GET</span>
                    <span class="endpoint-path">/api/admin/dashboard/stats</span>
                </div>
                <div class="endpoint-desc">Get platform statistics</div>
            </div>
        </div>

        <!-- Next Steps Section -->
        <div class="section">
            <h2>üöÄ Deployment Checklist</h2>
            <div class="info-box">
                <h4>Before Production</h4>
                <ol>
                    <li><strong>Environment Variables:</strong> Update all secrets in .env (JWT_SECRET, DB credentials)</li>
                    <li><strong>Database:</strong> Run schema.sql on production SQL Server</li>
                    <li><strong>Security:</strong> Enable HTTPS, configure CORS origins</li>
                    <li><strong>PSP Integration:</strong> Replace pspSimulator.js with actual payment gateway</li>
                    <li><strong>Logging:</strong> Configure Winston for production logging</li>
                    <li><strong>Monitoring:</strong> Add health checks and performance monitoring</li>
                    <li><strong>Rate Limiting:</strong> Fine-tune based on expected traffic</li>
                    <li><strong>Testing:</strong> Run integration tests for all endpoints</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    if (content.dataset.tabContent === tabName) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // Copy code functionality
        function copyCode(button) {
            const codeBlock = button.parentElement;
            const code = codeBlock.querySelector('pre').textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = 'Copy';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                button.textContent = 'Error!';
            });
        }

        // Add copy buttons to all code blocks
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Alpha Digiwallet Backend Code Package Ready');
        });
    </script>
</body>
</html>

